<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Registration | UniQRn</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="/supabaseClient.js"></script>
</head>
<body>
  <h1>Register</h1>
  <form id="registrationForm">
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit" id="registerButton">Register</button>
  </form>

  <script>
    // Utility to parse cookies into an object
    function parseCookies() {
      return document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.split('=').map(c => c.trim());
        acc[key] = value;
        return acc;
      }, {});
    }

    async function registerUser(event) {
      event.preventDefault();
      
      console.log('[registration] Starting registration process.');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      console.log('[registration] Email:', email);

      const cookies = parseCookies();
      const referralUserId = cookies.referral_user || null;
      if (referralUserId) {
        console.log('[registration] Found referral cookie:', referralUserId);
      } else {
        console.log('[registration] No referral cookie found.');
      }

      // Sign up using Supabase auth
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) {
        console.error('[registration] Registration error:', error);
        return;
      }
      console.log('[registration] Registration successful:', data);

      // After successful sign-up, update the user record with the referral parent_id if exists
      if (data.user && referralUserId) {
        console.log('[registration] Updating user record with parent_id:', referralUserId);
        const { error: updateError } = await supabase
          .from('app_users')
          .update({ parent_id: referralUserId })
          .eq('id', data.user.id);
        if (updateError) {
          console.error('[registration] Error updating parent_id:', updateError);
        } else {
          console.log('[registration] User parent_id updated successfully.');
        }
      }
      alert('Registration successful!');
    }

    document.getElementById('registrationForm').addEventListener('submit', registerUser);
  </script>
</body>
</html>
