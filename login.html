<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login - UniQRn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Load Supabase client from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- Environment settings -->
  <script src="/env.js"></script>
  <!-- Create the Supabase client -->
  <script src="/supabaseClient.js"></script>
</head>
<body>
  <p>Logging in with Googleâ€¦</p>
  <script>
    // Use the dedicated supabaseClient variable
    const SUPABASE_URL = window.SUPABASE_URL;
    const SUPABASE_KEY = window.SUPABASE_KEY;
    const supabaseClient = window.supabaseClient;

    // Function to initiate the OAuth login.
    async function initiateLogin() {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          // Redirect back to this page for token extraction.
          redirectTo: window.location.origin + window.location.pathname
        }
      });
      if (error) {
        document.body.innerHTML = "Error initiating login: " + error.message;
      }
    }

    // Function to exchange the code for a session.
    async function exchangeCode() {
      try {
        await supabaseClient.auth.exchangeCodeForSession();
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session && session.user) {
          // Redirect to callback page with token, user_id, and balance.
          const user = session.user;
          const token = user.id; // Here we use the user id as a token; you may use another field.
          const balance = 100.0; // Replace with actual balance if available.
          window.location.href = window.location.origin + "/login_callback.html?token=" + encodeURIComponent(token) +
                                   "&user_id=" + encodeURIComponent(user.id) +
                                   "&balance=" + encodeURIComponent(balance);
        } else {
          document.body.innerText = "Authentication failed. Please try again.";
        }
      } catch (err) {
        console.error(err);
        document.body.innerText = "Error during login: " + err.message;
      }
    }

    // Check if the URL has an OAuth code.
    const params = new URLSearchParams(window.location.search);
    if (params.has('code')) {
      exchangeCode();
    } else {
      initiateLogin();
    }
  </script>
</body>
</html>
